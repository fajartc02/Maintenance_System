-- INSERT INTO
--     m_parameter (
--         name,
--         aliases_name,
--         methode_check,
--         created_by,
--         upper_limit,
--         warning_ul,
--         units,
--         updated_by,
--         is_auto,
--         interval
--     )
-- VALUES
--     (
--         'ServoTemp_0_path1_IMZY_0002',
--         'Motor Temperature X Axis (IMZY-0002)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_1_path1_IMZY_0002',
--         'Motor Temperature Y Axis (IMZY-0002)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_2_path1_IMZY_0002',
--         'Motor Temperature Z Axis (IMZY-0002)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_3_path1_IMZY_0002',
--         'Motor Temperature U Axis (IMZY-0002)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path2_IMZY_0002',
--         'Motor Temperature V Axis (IMZY-0002)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path1_IMZY_0003',
--         'Motor Temperature X Axis (IMZY-0003)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_1_path1_IMZY_0003',
--         'Motor Temperature Y Axis (IMZY-0003)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_2_path1_IMZY_0003',
--         'Motor Temperature Z Axis (IMZY-0003)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_3_path1_IMZY_0003',
--         'Motor Temperature U Axis (IMZY-0003)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path2_IMZY_0003',
--         'Motor Temperature V Axis (IMZY-0003)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path1_IMZY_0004',
--         'Motor Temperature X Axis (IMZY-0004)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_1_path1_IMZY_0004',
--         'Motor Temperature Y Axis (IMZY-0004)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_2_path1_IMZY_0004',
--         'Motor Temperature Z Axis (IMZY-0004)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_3_path1_IMZY_0004',
--         'Motor Temperature U Axis (IMZY-0004)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path2_IMZY_0004',
--         'Motor Temperature V Axis (IMZY-0004)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path1_IMZY_0005',
--         'Motor Temperature X Axis (IMZY-0005)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_1_path1_IMZY_0005',
--         'Motor Temperature Y Axis (IMZY-0005)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_2_path1_IMZY_0005',
--         'Motor Temperature Z Axis (IMZY-0005)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_3_path1_IMZY_0005',
--         'Motor Temperature U Axis (IMZY-0005)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path2_IMZY_0005',
--         'Motor Temperature V Axis (IMZY-0005)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path1_IMZY_0006',
--         'Motor Temperature X Axis (IMZY-0006)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_1_path1_IMZY_0006',
--         'Motor Temperature Y Axis (IMZY-0006)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_2_path1_IMZY_0006',
--         'Motor Temperature Z Axis (IMZY-0006)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_3_path1_IMZY_0006',
--         'Motor Temperature U Axis (IMZY-0006)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path2_IMZY_0006',
--         'Motor Temperature V Axis (IMZY-0006)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path1_IMZY_0007',
--         'Motor Temperature X Axis (IMZY-0007)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_1_path1_IMZY_0007',
--         'Motor Temperature Y Axis (IMZY-0007)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_2_path1_IMZY_0007',
--         'Motor Temperature Z Axis (IMZY-0007)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_3_path1_IMZY_0007',
--         'Motor Temperature U Axis (IMZY-0007)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path2_IMZY_0007',
--         'Motor Temperature V Axis (IMZY-0007)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path1_IMZY_0008',
--         'Motor Temperature X Axis (IMZY-0008)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_1_path1_IMZY_0008',
--         'Motor Temperature Y Axis (IMZY-0008)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_2_path1_IMZY_0008',
--         'Motor Temperature Z Axis (IMZY-0008)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_3_path1_IMZY_0008',
--         'Motor Temperature U Axis (IMZY-0008)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     ),
--     (
--         'ServoTemp_0_path2_IMZY_0008',
--         'Motor Temperature V Axis (IMZY-0008)',
--         'Auto',
--         'Fajar',
--         75,
--         68,
--         '°C',
--         'Fajar',
--         1,
--         5
--     );


SELECT * FROM (
    SELECT row_number() OVER (ORDER BY tb.OrderDURATION DESC) AS rowNum, 
            MACHINE_CD, 
            LINE_NM, 
            PROBLEM_NM, 
            STUFF((SELECT ', ' + u.name
                        FROM OPENQUERY(PD_DB,'select TIME_AVAILABILITY_ID from tb_r_time_availability where status = 1 ') ta
                        JOIN [dbo].[TB_R_MACHINE_PROBLEM_D] mpd ON ta.TIME_AVAILABILITY_ID 	= mpd.TIME_AVAILABILITY_ID
                        JOIN [PD_DB].[pd_db].[public].[tb_m_users] u 	ON mpd.EMPLOYEE_ID = u.user_name	AND u.status=1
                    WHERE ta.time_availability_id = tb.time_availability_id
            FOR XML PATH('')), 1, 1, '') AS operator, 
            DURATION, 
            PLANT_NM, 
            DEPARTMENT_NM, 
            time_availability_id, 
            --IIF(warna = 0, 'Red', IIF(warna = 1, 'Yellow', IIF( warna = 2, 'Pink', 'default'))) AS color,
            IIF(warna = 0, 'default', IIF(warna = 1, 'Yellow', IIF( warna = 2, 'Pink', 'Red'))) AS color,
            problemDate
    FROM 
        (SELECT DISTINCT
            m.MACHINE_CD, l.LINE_NM, pr.PROBLEM_NM,  
            IIF(ta.end_time IS NULL, 
                IIF(DATEDIFF(day, ta.start_time, GETDATE())=0, 
                    CONCAT(DATEDIFF(hour, ta.start_time, GETDATE())%24, ' Hour ', DATEDIFF(minute, ta.start_time, GETDATE())%60, ' Minute'),
                    CONCAT(DATEDIFF(day, ta.start_time, GETDATE()), ' Day ', DATEDIFF(hour, ta.start_time, GETDATE())%24, ' Hour ', DATEDIFF(minute, ta.start_time, GETDATE())%60, ' Minute')
                    ), 
                IIF(DATEDIFF(day, ta.start_time, ta.end_time)=0, 
                    CONCAT(DATEDIFF(hour, ta.start_time, ta.end_time)%24, ' Hour ', DATEDIFF(minute, ta.start_time, ta.end_time)%60, ' Minute'),
                    CONCAT(DATEDIFF(day, ta.start_time, ta.end_time), ' Day ', DATEDIFF(hour, ta.start_time, ta.end_time)%24, ' Hour ', DATEDIFF(minute, ta.start_time, ta.end_time)%60, ' Minute')
                ) ) AS DURATION
            , 
            pl.PLANT_NM, d.DEPARTMENT_NM, ta.time_availability_id,
            IIF(ta.end_time IS NULL, DATEDIFF(minute, ta.start_time, GETDATE()),DATEDIFF(minute, ta.start_time, ta.end_time) ) AS OrderDURATION, ta.end_time ,
            --IIF(cm.cm_id IS NULL, 0, 1) + IIF(rc.root_cause_id IS NULL, 0, 2) AS warna,
            (SELECT [dbo].[fn_GetProblemColor] (ta.time_availability_id)) warna,
            convert(varchar, ta.start_time, 106) AS problemDate
            
        FROM OPENQUERY(PD_DB,'select time_availability_id, status, end_time, start_time, PROBLEM_ID, TIME_OUTPUT_REPORT_ID, MACHINE_ID from pd_db.public.tb_r_time_availability WHERE status = 1 AND end_time IS NOT NULL') ta
            left JOIN OPENQUERY(PD_DB,'SELECT PROBLEM_ID, status, PROBLEM_NM FROM pd_db.public.tb_m_problem')				pr	ON ta.PROBLEM_ID 			= pr.PROBLEM_ID		AND pr.status=1							
            LEFT JOIN [dbo].[TB_R_MACHINE_PROBLEM_D] mpd ON ta.TIME_AVAILABILITY_ID = mpd.TIME_AVAILABILITY_ID
            LEFT JOIN OPENQUERY(PD_DB,'SELECT user_name, status, name FROM pd_db.public.tb_m_users') u 	ON mpd.EMPLOYEE_ID 			= u.user_name	AND u.status=1
            LEFT JOIN OPENQUERY(PD_DB,'SELECT TIME_OUTPUT_REPORT_ID, status, REPORT_ID FROM tb_r_time_output_report') tor	ON ta.TIME_OUTPUT_REPORT_ID = tor.TIME_OUTPUT_REPORT_ID AND tor.status=1
            LEFT JOIN OPENQUERY(PD_DB,'SELECT REPORT_ID, status, DEPARTMENT_ID FROM pd_db.public.tb_r_report') r	ON tor.REPORT_ID 			= r.REPORT_ID		AND r.status=1
            LEFT JOIN OPENQUERY(PD_DB,'SELECT DEPARTMENT_ID, status, department_cd, DEPARTMENT_NM  FROM pd_db.public.tb_m_departments') d	ON r.DEPARTMENT_ID 			= d.DEPARTMENT_ID 	AND d.status=1
            LEFT JOIN OPENQUERY(PD_DB,'SELECT MACHINE_ID, status, LINE_ID, machine_cd  FROM pd_db.public.tb_m_machines') m	ON ta.MACHINE_ID 			= m.MACHINE_ID		AND m.status=1
            LEFT JOIN OPENQUERY(PD_DB,'SELECT id, status, SHOP_CD, line_cd, LINE_NM  FROM tb_m_lines')				l	ON m.LINE_ID 				= l.ID					AND l.status=1
            LEFT JOIN OPENQUERY(PD_DB,'SELECT SHOP_CD, status, PLANT_CD  FROM tb_m_shops') s	ON l.SHOP_CD 				= s.SHOP_CD				AND s.status=1
            LEFT JOIN OPENQUERY(PD_DB,'SELECT PLANT_CD, status, PLANT_NM FROM tb_m_plant') pl	ON s.PLANT_CD 				= pl.PLANT_CD			AND pl.status=1
            LEFT JOIN tb_r_countermeasure cm ON ta.time_availability_id = cm.time_availability_id 
            LEFT JOIN tb_r_root_cause rc ON ta.time_availability_id = rc.time_availability_id
        WHERE 1=1 AND ta.[status] = 1 and ta.end_time is not null  AND (l.parent -id= '4340CA1200001')) tb
    ) tc
WHERE tc.rowNum BETWEEN 1 AND 10;